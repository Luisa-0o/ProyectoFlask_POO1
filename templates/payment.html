{% extends "base.html" %}
{% block title %}Pago{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">ðŸ’³ Procesar Pago</h2>

  <div class="row">
    <!-- Resumen del Pedido -->
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">ðŸ“¦ Resumen del Pedido</h5>
        </div>
        <div class="card-body">
          {% if order %}
            <p><strong>NÃºmero de Pedido:</strong> #{{ order.id }}</p>
            <p><strong>Fecha:</strong> {{ order.created_at.strftime('%d/%m/%Y %H:%M') if order.created_at else 'N/A' }}</p>
            <p><strong>Estado:</strong> <span class="badge bg-warning">{{ order.status }}</span></p>
            <hr>
            
            <h6>Productos:</h6>
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Qty</th>
                  <th>Precio</th>
                  <th>Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order.items %}
                <tr>
                  <td>{{ item.book.title[:20] }}...</td>
                  <td>{{ item.quantity }}</td>
                  <td>${{ "%.2f"|format(item.price) }}</td>
                  <td>${{ "%.2f"|format(item.quantity * item.price) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <hr>
            <h5 class="text-end">Total: <span class="text-primary">${{ "%.2f"|format(order.total) }}</span></h5>
            
            <!-- BotÃ³n para ver factura -->
            <a href="{{ url_for('view_invoice', order_id=order.id) }}" class="btn btn-outline-primary w-100 mt-3">
              ï¿½ Ver Factura
            </a>
          {% else %}
            <p class="text-muted">No hay pedido disponible.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Formulario de Pago -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">MÃ©todo de Pago</h5>
        </div>
        <div class="card-body">
          <form method="POST" class="p-4 border rounded shadow-sm bg-light">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="mb-3">
              <label for="payment_method" class="form-label">MÃ©todo de pago</label>
              <select name="payment_method" id="payment_method" class="form-select" required>
                <option value="">Seleccione un mÃ©todo</option>
                <option value="visa">Visa</option>
                <option value="mastercard">MasterCard</option>
                <option value="efecty">Efecty</option>
              </select>
            </div>

            <!-- Campos para tarjeta -->
            <div id="cardFields">
              <div class="mb-3">
                <label for="card_number" class="form-label">NÃºmero de Tarjeta</label>
                <input type="text" class="form-control" id="card_number" name="card_number" placeholder="1234 5678 9012 3456">
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="expiry_date" class="form-label">Fecha de ExpiraciÃ³n</label>
                  <input type="text" class="form-control" id="expiry_date" name="expiry_date" placeholder="MM/AA">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="cvv" class="form-label">CVV</label>
                  <input type="text" class="form-control" id="cvv" name="cvv" placeholder="123">
                </div>
              </div>
            </div>

            <div id="efectyInfo" style="display:none;">
              <div class="alert alert-warning mt-3">
                Para pagar con <strong>Efecty</strong>, recibirÃ¡s un cÃ³digo para presentarlo en un punto Efecty.
              </div>
            </div>

            <button type="submit" class="btn btn-success w-100 mt-3">âœ… Confirmar Pago</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Mostrar u ocultar los campos segÃºn el mÃ©todo de pago
  const select = document.getElementById('payment_method');
  const cardFields = document.getElementById('cardFields');
  const efectyInfo = document.getElementById('efectyInfo');

  select.addEventListener('change', function() {
    if (this.value === 'efecty') {
      cardFields.style.display = 'none';
      efectyInfo.style.display = 'block';
    } else if (this.value === 'visa' || this.value === 'mastercard') {
      cardFields.style.display = 'block';
      efectyInfo.style.display = 'none';
    } else {
      cardFields.style.display = 'none';
      efectyInfo.style.display = 'none';
    }
  });
</script>
{% endblock %}
